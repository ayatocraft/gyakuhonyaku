<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逆翻訳アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ローディングアニメーション */
        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4f46e5;
            color: #4f46e5;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4f46e5;
            color: #4f46e5;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #4f46e5;
            color: #4f46e5;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: #4f46e5; }
            50%, 100% { background-color: #c7d2fe; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-2xl shadow-lg">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">逆翻訳アプリ</h1>
                <p class="mt-2 text-gray-600">テキストや音声を5ヶ国語を経由して翻訳し、意図しない面白い表現を探してみましょう。</p>
            </div>

            <!-- Main Content -->
            <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Input Column -->
                <div class="flex flex-col space-y-4">
                    <div>
                        <label for="source-lang" class="block text-sm font-medium text-gray-700 mb-1">入力言語</label>
                        <select id="source-lang" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                            <option value="ja-JP">日本語</option>
                            <option value="en-US">英語</option>
                            <option value="ko-KR">韓国語</option>
                            <option value="fr-FR">フランス語</option>
                            <option value="es-ES">スペイン語</option>
                            <option value="de-DE">ドイツ語</option>
                            <option value="hi-IN">ヒンディー語</option>
                        </select>
                    </div>
                    <div class="relative flex-grow">
                        <textarea id="input-text" rows="8" class="w-full h-full p-3 text-base text-gray-700 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="ここにテキストを入力するか、マイクボタンを押して話してください..."></textarea>
                        <button id="speak-input-btn" class="absolute bottom-3 right-14 p-2 rounded-full bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-transform transform active:scale-95" disabled>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                        </button>
                        <button id="mic-btn" class="absolute bottom-3 right-3 p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform active:scale-95">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- Output Column -->
                <div class="flex flex-col space-y-4">
                    <div>
                        <label for="target-lang" class="block text-sm font-medium text-gray-700 mb-1">出力言語</label>
                        <select id="target-lang" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                            <option value="ja">日本語</option>
                            <option value="en">英語</option>
                        </select>
                    </div>
                    <div class="relative flex-grow bg-gray-50 border border-gray-200 rounded-lg">
                        <div id="output-container" class="w-full h-full p-3 text-base text-gray-800 overflow-y-auto">
                            <span class="text-gray-400">翻訳結果がここに表示されます。</span>
                        </div>
                        <button id="speak-btn" class="absolute bottom-3 right-3 p-2 rounded-full bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-transform transform active:scale-95" disabled>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                        </button>
                         <div id="loader" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-lg hidden">
                            <div class="dot-flashing"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Translate Button -->
            <div class="px-6 pb-6 text-center">
                 <button id="translate-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-12 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform active:scale-95 disabled:bg-indigo-300 disabled:cursor-not-allowed" disabled>
                    翻訳する
                </button>
            </div>

            <!-- Intermediate Steps -->
            <div id="intermediate-steps-container" class="px-6 pb-6 hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">翻訳の途中経過</h3>
                <div id="intermediate-steps" class="p-4 bg-gray-50 rounded-lg space-y-2 text-sm text-gray-600 border">
                </div>
            </div>

        </div>
    </div>

<script>
const sourceLangSelect = document.getElementById('source-lang');
const targetLangSelect = document.getElementById('target-lang');
const inputTextElem = document.getElementById('input-text');
const outputContainer = document.getElementById('output-container');
const micBtn = document.getElementById('mic-btn');
const translateBtn = document.getElementById('translate-btn');
const speakBtn = document.getElementById('speak-btn');
const speakInputBtn = document.getElementById('speak-input-btn');
const loader = document.getElementById('loader');
const intermediateStepsContainer = document.getElementById('intermediate-steps-container');
const intermediateStepsElem = document.getElementById('intermediate-steps');

// 経由する言語のリスト
const intermediateLangs = [
    { code: 'ko', name: '韓国語' },
    { code: 'fr', name: 'フランス語' },
    { code: 'om', name: 'オロモ語' },
    { code: 'ak', name: 'トゥイ語' }, // TwiはAkan語(ak)の方言
    { code: 'hi', name: 'ヒンディー語' }
];

// Speech Recognition (音声認識) の設定
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = sourceLangSelect.value;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        inputTextElem.value = transcript;
        if (transcript) translateBtn.disabled = false;
    };

    recognition.onerror = (event) => {
        console.error('Speech Recognition Error:', event.error);
        alert(`音声認識エラー: ${event.error}`);
    };

    recognition.onend = () => {
        micBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        micBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        micBtn.disabled = false;
    };
    
    micBtn.addEventListener('click', () => {
        // 'speechSynthesis'が話している場合は停止する
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
        }

        try {
            recognition.lang = sourceLangSelect.value;
            recognition.start();
            micBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            micBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            micBtn.disabled = true;
            inputTextElem.value = '話してください...';
            translateBtn.disabled = true;
        } catch (e) {
            console.error("Speech recognition could not start: ", e);
            alert("音声認識を開始できませんでした。ブラウザが対応しているか、マイクの権限が許可されているか確認してください。");
            micBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            micBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            micBtn.disabled = false;
        }
    });
} else {
    micBtn.disabled = true;
    micBtn.title = "お使いのブラウザは音声認識をサポートしていません。";
    console.log("Speech Recognition not supported.");
}

// テキスト翻訳関数
async function translateText(text, fromLang, toLang) {
    if (!text) return '';
    const from = fromLang.split('-')[0];
    const to = toLang.split('-')[0];
    const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`;

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        if (data.responseStatus === 200 && data.responseData.translatedText) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = data.responseData.translatedText;
            return tempDiv.textContent || tempDiv.innerText || "";
        } else {
            console.warn(`Translation from ${from} to ${to} failed. Details: ${data.responseDetails}`);
            return `${text} [${to}への翻訳失敗]`;
        }
    } catch (error) {
        console.error('Translation API fetch error:', error);
        return `${text} [APIエラー]`;
    }
}

// 翻訳実行ボタンのイベント
translateBtn.addEventListener('click', async () => {
    const inputText = inputTextElem.value.trim();
    if (!inputText) {
        alert('翻訳するテキストを入力してください。');
        return;
    }

    loader.classList.remove('hidden');
    translateBtn.disabled = true;
    speakBtn.disabled = true;
    outputContainer.innerHTML = '<span class="text-gray-400">翻訳中...</span>';
    intermediateStepsElem.innerHTML = '';
    intermediateStepsContainer.classList.remove('hidden');

    let currentText = inputText;
    let currentLang = sourceLangSelect.value;
    
    intermediateStepsElem.innerHTML += `<p><strong>元 (${currentLang.split('-')[0]}):</strong> ${currentText}</p>`;
    
    for (const lang of intermediateLangs) {
        const translatedText = await translateText(currentText, currentLang, lang.code);
        intermediateStepsElem.innerHTML += `<p><strong>&rarr; ${lang.name} (${lang.code}):</strong> ${translatedText}</p>`;
        // エラーメッセージを取り除いて次の翻訳に渡す
        currentText = translatedText.replace(/ \[\w+への翻訳失敗\]| \[APIエラー\]/g, '');
        currentLang = lang.code;
    }
    
    const finalLang = targetLangSelect.value;
    const finalText = await translateText(currentText, currentLang, finalLang);
    
    outputContainer.textContent = finalText;
    
    loader.classList.add('hidden');
    translateBtn.disabled = false;
    if(finalText) speakBtn.disabled = false;
});

// 読み上げボタンのイベント
speakBtn.addEventListener('click', () => {
    const textToSpeak = outputContainer.textContent;
    if (textToSpeak && 'speechSynthesis' in window) {
        // 音声認識が動いている場合は停止する
        if (recognition && typeof recognition.stop === 'function') {
            try { recognition.stop(); } catch(e) { console.error(e); }
        }
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        utterance.lang = targetLangSelect.value;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    }
});

// 入力テキスト用の読み上げボタンイベント
speakInputBtn.addEventListener('click', () => {
    const textToSpeak = inputTextElem.value;
    if (textToSpeak && 'speechSynthesis' in window) {
        if (recognition && typeof recognition.stop === 'function') {
             try { recognition.stop(); } catch(e) { console.error(e); }
        }
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        utterance.lang = sourceLangSelect.value;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    }
});

// 入力テキストエリアのイベント
inputTextElem.addEventListener('input', () => {
    const hasText = inputTextElem.value.trim() !== '';
    translateBtn.disabled = !hasText;
    speakInputBtn.disabled = !hasText;
});

// 入力言語が変更されたら、音声認識の言語も変更
sourceLangSelect.addEventListener('change', (e) => {
    if (recognition) {
        recognition.lang = e.target.value;
    }
});

// Speech Synthesisのウォームアップ
function warmUpSpeechSynthesis() {
    if ('speechSynthesis' in window) {
        // 空のテキストを読み上げさせることで、一部のブラウザで音声エンジンを初期化する
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(''));
    }
}
window.addEventListener('load', warmUpSpeechSynthesis, { once: true });

</script>
</body>
</html>

